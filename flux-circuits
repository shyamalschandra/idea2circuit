#!/bin/bash
# Flux Circuits wrapper script
# This script is installed by Homebrew and provides the main entry point

# Get the installation directory (set by Homebrew)
INSTALL_DIR="${HOMEBREW_PREFIX}/opt/flux-circuits/libexec"

# Fallback to script directory if not in Homebrew environment
if [ ! -d "${INSTALL_DIR}" ]; then
  SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
  INSTALL_DIR="${SCRIPT_DIR}"
fi

# Set up Node.js path
export NODE_PATH="${INSTALL_DIR}/node_modules:${NODE_PATH}"

# Create .env from .env.example if it doesn't exist
ENV_FILE="${HOME}/.flux-circuits/.env"
ENV_EXAMPLE="${INSTALL_DIR}/../etc/flux-circuits/.env.example"

# Fallback for non-Homebrew installations
if [ ! -f "${ENV_EXAMPLE}" ]; then
  ENV_EXAMPLE="${INSTALL_DIR}/.env.example"
fi

if [ ! -f "${ENV_FILE}" ]; then
  mkdir -p "${HOME}/.flux-circuits"
  if [ -f "${ENV_EXAMPLE}" ]; then
    cp "${ENV_EXAMPLE}" "${ENV_FILE}"
    echo "Created ${ENV_FILE} from template. Please edit it and add your API keys."
  fi
fi

# Load environment variables
if [ -f "${ENV_FILE}" ]; then
  set -a
  source "${ENV_FILE}"
  set +a
fi

# Run the zsh script with proper paths
cd "${INSTALL_DIR}"
exec zsh "${INSTALL_DIR}/idea-to-circuit.zsh" "$@"
